= Apply Oauth2 Client to a Batch Application

== Introduction

== Add Dependencies

Add libraries to build.gradle.kts

.build.gradle.kts
[source,kotlin]
----
dependencies {
implementation("org.springframework.boot:spring-boot-starter-oauth2-client")
    // other dependencies
}
----

== Create a new Client

=== Insert new client

[source,sql]
----
select uuid_generate_v4();
-- 762475e5-a75b-4288-a653-a4bf3574c5bb

INSERT INTO public.oauth2_registered_client
(id, client_id, client_id_issued_at, client_secret, client_secret_expires_at,
 client_name, client_authentication_methods, authorization_grant_types, redirect_uris,
 post_logout_redirect_uris, scopes, client_settings, token_settings)
VALUES ('762475e5-a75b-4288-a653-a4bf3574c5bb', 'nsa2-cronjob-example', now(), '{bcrypt}$2a$10$ZJkIZl2ew5fRjpX4VPkRcOwioG8n6vuD7//QZJ/QWlyzi59l5HW5u', null,
        'NSA2 Cronjob Example', 'client_secret_basic', 'refresh_token,client_credentials,authorization_code', 'http://nsa2-cronjob-example:8080/login/oauth2/code/nsa2-cronjob-example', 'http://nsa2-cronjob-example:8080/logged-out', 'openid,profile,nsa2.user.all,nsa2.user.read,nsa2.user.write,nsa2.admin', '{"@class":"java.util.Collections$UnmodifiableMap","settings.client.require-proof-key":false,"settings.client.require-authorization-consent":false}', '{"@class":"java.util.Collections$UnmodifiableMap","settings.token.reuse-refresh-tokens":true,"settings.token.x509-certificate-bound-access-tokens":false,"settings.token.id-token-signature-algorithm":["org.springframework.security.oauth2.jose.jws.SignatureAlgorithm","RS256"],"settings.token.access-token-time-to-live":["java.time.Duration",300.000000000],"settings.token.access-token-format":{"@class":"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat","value":"self-contained"},"settings.token.refresh-token-time-to-live":["java.time.Duration",3600.000000000],"settings.token.authorization-code-time-to-live":["java.time.Duration",300.000000000],"settings.token.device-code-time-to-live":["java.time.Duration",300.000000000]}');
----


== Configure the Client

Add the following properties to application.yml

[source,yaml]
----
spring.security.oauth2.client:
  registration:
    nsa2-cronjob-example:
      provider: ${NSA2_OAUTH_PROVIDER:spring}
      client-id: ${NSA2_OAUTH_CLIENT_ID:nsa2-cronjob-example}
      client-secret: ${NSA2_OAUTH_CLIENT_SECRET:secret}
      authorization-grant-type: ${NSA2_OAUTH_GRANT_TYPE:authorization_code}
      scope: ${NSA2_OAUTH_SCOPE:openid,profile}
      #      scope: openid,profile,nsa2.user.all,nsa2.user.read,nsa2.user.write,nsa2.admin
      #      redirect-uri: "http://127.0.0.1:8080/authorized"
      redirect-uri: ${NSA2_OAUTH_REDIRECT_URI:http://nsa2-cronjob-example:8080/login/oauth2/code/{registrationId}}
      #client-name: nsa2-oidc
      #client-authentication-method: ${NSA2_OAUTH_CLIENT_AUTH_METHOD:client_secret_basic}
      client-name: ${NSA2_OAUTH_CLIENT_NAME:"NSA2 Cronjob Example"}


  provider:
    spring:
      issuer-uri: ${NSA2_OAUTH_ISSUER_URI:http://nsa2-auth-server:9000}
----
